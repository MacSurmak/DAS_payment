from aiogram_dialog import DialogManager
from aiogram_dialog.widgets.text import Format
from loguru import logger

# --- Lexicon Structure ---
LEXICON: dict[str, dict[str, str]] = {
    "ru": {
        # General
        "unsupported_message": "–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–µ–Ω—é.",
        "back_button": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
        "confirm_button": "‚úÖ –í—Å–µ –≤–µ—Ä–Ω–æ",
        "close_button": "‚ùå –ó–∞–∫—Ä—ã—Ç—å",
        # Weekdays
        "weekday_0": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
        "weekday_1": "–í—Ç–æ—Ä–Ω–∏–∫",
        "weekday_2": "–°—Ä–µ–¥–∞",
        "weekday_3": "–ß–µ—Ç–≤–µ—Ä–≥",
        "weekday_4": "–ü—è—Ç–Ω–∏—Ü–∞",
        "weekday_5": "–°—É–±–±–æ—Ç–∞",
        "weekday_6": "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
        # Commands
        "start_new_user": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.",
        "start_registered_user": "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π. –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—É—é.",
        "start_already_booked": "–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ <b>{date} ({weekday}) –≤ {time}</b>.\n–û–∫–Ω–æ ‚Ññ{window}.\n\n–î–ª—è –æ—Ç–º–µ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /cancel.",
        "help_command": "–° –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ –±–æ—Ç–∞ —Ç—ã –º–æ–∂–µ—à—å –≤—Å—Ç–∞—Ç—å –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –æ–ø–ª–∞—Ç—É –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –≤ –î–ê–° –ú–ì–£.\n\n"
        "–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ–±–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ —Å—É—Ç–∫–∏ –∏ –∑–∞ —á–∞—Å –¥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.\n\n"
        "<b>–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ:</b> –æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ –≤–æ–∑–º–æ–∂–Ω–∞ –Ω–µ –ø–æ–∑–¥–Ω–µ–µ, —á–µ–º –∑–∞ 3 —á–∞—Å–∞ –¥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏!",
        "cancel_no_booking": "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã.",
        "cancel_successful": "‚úÖ –í–∞—à–∞ –∑–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ.",
        "cancel_failed_too_late": "‚ùå –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞! –û—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω–µ–µ 3-—Ö —á–∞—Å–æ–≤.",
        # Admin Commands
        "admin_grant_success": "‚úÖ –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /apanel –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å.",
        "admin_already_admin": "–í—ã —É–∂–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.",
        "admin_wrong_password": "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.",
        "admin_not_registered": "–°–Ω–∞—á–∞–ª–∞ –≤–∞–º –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ /start.",
        # Registration Dialog
        "get_name_prompt": "üìù –î–ª—è –Ω–∞—á–∞–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–∏ –§–∞–º–∏–ª–∏—é, –ò–º—è –∏ –û—Ç—á–µ—Å—Ç–≤–æ (–µ—Å–ª–∏ –µ—Å—Ç—å).",
        "name_invalid": "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ 2 –∏–ª–∏ 3 —Å–ª–æ–≤–∞ (–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ).",
        "get_faculty_prompt": "üéì –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ñ–∞–∫—É–ª—å—Ç–µ—Ç:",
        "get_degree_prompt": "üìö –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–ø–µ–Ω—å –æ–±—É—á–µ–Ω–∏—è:",
        "get_year_prompt": "üóìÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∫—É—Ä—Å:",
        "bachelor": "–ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç",
        "master": "–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞",
        "specialist": "–°–ø–µ—Ü–∏–∞–ª–∏—Ç–µ—Ç",
        "confirm_prompt": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n\n"
        "<b>–§–ò–û:</b> {last_name} {first_name} {patronymic}\n"
        "<b>–§–∞–∫—É–ª—å—Ç–µ—Ç:</b> {faculty}\n"
        "<b>–û–±—É—á–µ–Ω–∏–µ:</b> {degree}, {year} –∫—É—Ä—Å\n\n"
        "–í—Å–µ –≤–µ—Ä–Ω–æ?",
        "registration_successful": "‚úÖ –û—Ç–ª–∏—á–Ω–æ, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–∏—Å–∏.",
        # Schedule Dialog
        "get_date_prompt": "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—É—é –¥–∞—Ç—É –¥–ª—è –∑–∞–ø–∏—Å–∏:",
        "get_time_prompt": "üïí –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ <b>{selected_date_str}</b>:",
        "no_slots_available": "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.",
        "confirm_booking_prompt": "–í—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ <b>{date} ({weekday}) –≤ {time}</b>?",
        "booking_successful": "‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã!",
        "booking_failed_already_booked": "‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞–ø–∏—Å—å.",
        "booking_failed_too_late": "‚ùå –≠—Ç–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.",
        # Booking Management Dialog
        "my_booking_title": "<b>–í–∞—à–∞ —Ç–µ–∫—É—â–∞—è –∑–∞–ø–∏—Å—å:</b>\n\n"
        "<b>–î–∞—Ç–∞:</b> {date} ({weekday})\n"
        "<b>–í—Ä–µ–º—è:</b> {time}\n"
        "<b>–û–∫–Ω–æ:</b> ‚Ññ{window}",
        "cancel_booking_button": "üö´ –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å",
        "confirm_cancel_prompt": "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?",
        "confirm_cancel_button": "–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å",
        # Admin Dialog
        "admin_panel_title": "–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
        "admin_stats_info": "–ó–∞–ø–∏—Å–∞–Ω–æ: {booked_users}\n–í—Å–µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: {total_users}",
        "admin_get_report": "üìà –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç (.xlsx)",
        "admin_set_last_day": "üóìÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏",
        "admin_broadcast": "üì¢ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É",
        "admin_manage_schedule": "üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º",
        "admin_schedule_menu_prompt": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º:",
        "admin_block_day": "üö´ –°–¥–µ–ª–∞—Ç—å –¥–µ–Ω—å/—Å–ª–æ—Ç –Ω–µ—Ä–∞–±–æ—á–∏–º",
        "admin_block_day_prompt": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ:",
        "admin_block_type_prompt": "–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å –¥–∞—Ç–æ–π <b>{date_to_block}</b>?",
        "admin_block_whole_day": "–°–¥–µ–ª–∞—Ç—å –≤–µ—Å—å –¥–µ–Ω—å –Ω–µ—Ä–∞–±–æ—á–∏–º",
        "admin_block_time_slot": "–£–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–ª–æ—Ç",
        "admin_select_slot_to_block_prompt": "–ö–∞–∫–æ–π —Å–ª–æ—Ç —É–±—Ä–∞—Ç—å –Ω–∞ <b>{date_to_block}</b>?",
        "admin_block_day_select_window_prompt": "–î–ª—è –∫–∞–∫–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ <b>{date_to_block}</b>?",
        "admin_window_1": "–û–∫–Ω–æ 1",
        "admin_window_2": "–û–∫–Ω–æ 2",
        "admin_window_3": "–û–∫–Ω–æ 3",
        "admin_all_windows": "–í—Å–µ –æ–∫–Ω–∞",
        "admin_day_blocked_success": "‚úÖ –î–µ–Ω—å {date} —É—Å–ø–µ—à–Ω–æ —Å–¥–µ–ª–∞–Ω –Ω–µ—Ä–∞–±–æ—á–∏–º.",
        "admin_time_slot_blocked_success": "‚úÖ –°–ª–æ—Ç —Å {start} –¥–æ {end} –Ω–∞ {date} —É—Å–ø–µ—à–Ω–æ —É–±—Ä–∞–Ω –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.",
        "report_generation_started": "–ù–∞—á–∏–Ω–∞—é —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è...",
        "report_generation_failed": "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç.",
        "admin_select_date_prompt": "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å, –¥–æ—Å—Ç—É–ø–Ω—ã–π –¥–ª—è –∑–∞–ø–∏—Å–∏:",
        "last_day_set_success": "‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –¥–ª—è –∑–∞–ø–∏—Å–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {date}.",
        "admin_broadcast_prompt": "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:",
        "admin_broadcast_confirm_prompt": "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ?\n\n<pre>{broadcast_text}</pre>",
        "broadcast_started": "–ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É...",
        "broadcast_finished": "‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}\n–ù–µ —É–¥–∞–ª–æ—Å—å: {failed}",
        # Notifications
        "notification_day_before": "–ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –≤—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –î–ê–° <b>–∑–∞–≤—Ç—Ä–∞ –≤ {time}</b>.\n–û–∫–Ω–æ ‚Ññ{window}.",
        "notification_hour_before": "–ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –≤—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –î–ê–° —É–∂–µ <b>—á–µ—Ä–µ–∑ —á–∞—Å, –≤ {time}</b>.\n–û–∫–Ω–æ ‚Ññ{window}.",
        # Throttling
        "throttling_warning": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ —Ç–∞–∫ —á–∞—Å—Ç–æ! –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.",
    }
}

# --- Bot Commands ---
LEXICON_COMMANDS: dict[str, str] = {
    "/start": "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è / –ú–æ—è –∑–∞–ø–∏—Å—å",
    "/help": "–°–ø—Ä–∞–≤–∫–∞",
}

# --- Supported Languages ---
LANGUAGES = [
    {"code": "ru", "name": "–†—É—Å—Å–∫–∏–π üá∑üá∫"},
]
DEFAULT_LANG = "ru"


# --- Localization Functions ---
def lexicon(lang: str | None, key: str, **kwargs) -> str:
    """
    Gets a localized string from the lexicon.
    """
    if lang not in LEXICON:
        lang = DEFAULT_LANG

    text_template = LEXICON.get(lang, {}).get(key, f"err:NO_KEY_{key}")
    return text_template.format(**kwargs) if kwargs else text_template


class LocalizedTextFormat(Format):
    """
    Custom aiogram-dialog widget to format text using the lexicon.
    """

    def __init__(self, key: str):
        super().__init__(text=f"{{{key}}}")
        self.key = key

    async def _render_text(self, data: dict, manager: DialogManager) -> str:
        lang = manager.middleware_data.get("lang", DEFAULT_LANG)
        return lexicon(lang, self.key, **data)
